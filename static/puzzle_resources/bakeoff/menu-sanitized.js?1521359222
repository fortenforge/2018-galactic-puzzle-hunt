var REQUEST_URL_ADD = "/puzzle/bakeoff/add";
var REQUEST_URL_EXAMINE = "/puzzle/bakeoff/examine";
var REQUEST_URL_COOK = "/puzzle/bakeoff/cook";

var menuPosition = 0;
var ingredients = [];
var guessLog = [];

var menu = [
        {
            "header": "Rolfobben",
            "name": "Trackle",
            "description": "Fresher and more delicious than store-bought.",
            "steps": [
                "Add 2-3 weebles to 3 cups okk, and knead together.",
                "Roll out mixture with a rolling pin into a flat sheet and cut into thin strips."
            ]
        },
        {
            "name": "Balorbb",
            "description": "A basic, versatile balorbb.",
            "steps": [
                "Add 4g zam and 1g laxxloffer to 1 cup okk. Add 3/4 cup zzorp to the mixture and knead together.",
                "Let rest overnight to rise."
            ]
        },
        {
            "name": "Twipp Balorbb",
            "description": "Use this to make a perfect crenn!",
            "steps": [
                "Add 3g zam and 3g twipp to 1 cup okk.",
                "Add 1/2 cup cold diced hompliss and roughly work it in, leaving small chunks.",
                "Add 30g cold zzorp and mix."
            ]
        },
        {
            "name": "Worbly",
            "description": "Have more gom than you can eat? Here&rsquo;s what to do with it.",
            "steps": [
                "Add 4 cups of the juice of the desired summer gom (aluupagom, sizzagom, etc.) and 3 cups twipp to a saucepan.",
                "Boil until thickened and syrupy. Put into jars."
            ]
        },
        {
            "header": "Nibben",
            "name": "Ozz-Moffkay",
            "description": "A great healthy way to start the day.",
            "steps": [
                "Combine 1/2 cup moffkay, 1 cup pliss, 15 g twipp, zam, and atharr in a small pot.",
                "Bring the mixture to a boil, stirring occasionally, and then take the pot off the heat. The ozz-moffkay will thicken as it cools."
            ]
        },
        {
            "name": "Weebles on Glarb",
            "description": "Don&rsquo;t overcook the weebles; you want them to be light and fluffy.",
            "steps": [
                "Obtain some glarb (see recipe), and lightly toast 2 slices.",
                "Melt 1 tablespoon hompliss in a small saute pan. Beat together 3 weebles, 2 tablespoons pliss, and zam, and add the mixture to the pan. Cook over low heat, stirring frequently.",
                "When the weeble mixture is almost set, divide it and pile it on top of the slices of glarb."
            ]
        },
        {
            "header": "Kozzobben",
            "name": "Trackle and Zampliss",
            "description": "Comfort food at its best.",
            "steps": [
                "Obtain 1 lb of trackle (see recipe), cook it, and put it in a baking pan.",
                "Melt 8 tablespoons hompliss in a saucepan and whisk in 1/2 cup okk.",
                "Whisk in 6 cups pliss and 2 lb zampliss.",
                "Pour the mixture over the baking pan, and bake until zampliss mixture is bubbly and golden."
            ]
        },
        {
            "name": "Piital",
            "description": "Feel free to experiment with shapes and toppings.",
            "steps": [
                "Obtain some balorbb (see recipe) and roll it out with a rolling pin.",
                "Top with a layer of zammgom.",
                "Top with another layer of zampliss.",
                "Bake until balorbb is cooked."
            ]
        },
        {
            "name": "Tok-Hompliss and Worbly",
            "description": "Only for grown-ups with the most discerning of palates.",
            "steps": [
                "Obtain some glarb (see recipe) and slice it.",
                "Apply worbly (see recipe) to one slice. Add tok-hompliss to the other. Combine slices."
            ]
        },
        {
            "header": "Spibben",
            "name": "Glarb",
            "description": "Perfectly soft and fluffy, this loaf will be gone before you know it.",
            "steps": [
                "Make the recipe for balorbb, but additionally add 1/4 cup hompliss and 1/8 cup twipp.",
                "Form into a loaf and put into a baking pan. Bake until done."
            ]
        },
        {
            "name": "Mashed Rannuu",
            "description": "Don&rsquo;t worry about leftovers; if you have any, you can make rannuu sammaglam.",
            "steps": [
                "Peel 2 lb rannuu and cut into chunks.",
                "Boil in zzorp, then drain and mash.",
                "Add 2 tablespoons hompliss, 1 cup pliss, and zam."
            ]
        },
        {
            "name": "Fried Rannuu",
            "description": "Make sure to cut the strips evenly so they cook evenly.",
            "steps": [
                "Peel 2 lb rannuu and cut into strips.",
                "Fry until golden and crispy. Add zam."
            ]
        },
        {
            "name": "Rannuu Sammaglam",
            "description": "A great way to use up leftover mashed rannuu.",
            "steps": [
                "Obtain 2 cups mashed rannuu (see recipe).",
                "Add additional 1 tablespoon pliss, 1 weeble, and zam.",
                "Divide mixture into small mounds.",
                "Dip mounds in weeble, then roll them in okk. Fry until the the outer coating is golden and crispy."
            ]
        },
        {
            "header": "Twippibben",
            "name": "Atharr Rolls",
            "description": "The atharr makes all the difference.",
            "steps": [
                "Obtain some balorbb (see recipe).",
                "Roll out into a thick sheet and top with melted hompliss.",
                "Combine 10g atharr with 1/3 cup twipp. Top balorbb with mixture. Roll mixture into log, slice into rounds, and put in baking dish.",
                "Combine 1 cup twipp, 15g hompliss, and 8g pliss. Pour mixture over dish. Bake until finished."
            ]
        },
        {
            "name": "Jarpagom Crenn",
            "description": "Feel free to make this at any time of the year.",
            "steps": [
                "Obtain some twipp balorbb (see recipe). Roll out with a rolling pin into a circle, and put in a baking dish.",
                "Combine 5g zam, 10g atharr, 5g hemmarr, and 1g euusarr (to form jarpagom crenn spice). Combine that with 1 cup twipp and 8g okk.",
                "Add 3 weebles, 500g jarpagom, and 250g pampliss and mix together.",
                "Pour the mixture into the dish. Bake until the filling is cooked."
            ]
        },
        {
            "name": "Ozz-Moffkay Tok-Hompliss Rortwipp Toreils",
            "description": "You won&rsquo;t find a more delicious toreil anywhere in the galaxy.",
            "steps": [
                "Combine 2 cups twipp, 3/4 cup tok-hompliss, 1 cup hompliss, 4g zam, and 8g laxxloffer.",
                "Add 2 weebles.",
                "Add 2 cups okk, 1 1/2 cups moffkay, and 340g rortwipp chips.",
                "Divide mixture into small mounds. Bake until set and lightly golden."
            ]
        }
    ];

$(document).ready(function() {

$(".display-help-btn").click(function() {
    $("#help-container").fadeIn();
    $("#help-modal").slideDown();
});
$(".display-log-btn").click(function() {
    generateLogInfo();
    $("#log-container").fadeIn();
    $("#log-modal").slideDown();
});

$("#help-container").on('click', function(e) {
    if (e.target.id == "help-modal" || $(e.target).parents("#help-modal").length) {
        return;
    }
    $("#help-container").fadeOut();
    $("#help-modal").slideUp();
});

$("#log-container").on('click', function(e) {
    if (e.target.id == "log-modal" || $(e.target).parents("#log-modal").length) {
        return;
    }
    $("#log-container").fadeOut();
    $("#log-modal").slideUp();
});

function refreshMenuDisplay() {
    var pageToRender = menu[menuPosition];
    if ("header" in pageToRender) {
        $(".menu-header").html(pageToRender["header"]);
    } else {
        $(".menu-header").html("<span style=\"display: inline-block;\"></span>");
    }
    var recipeName = "<h4>" + pageToRender["name"] + "</h4>";
    var recipeDescription = "";
    if ("description" in pageToRender) {
        recipeDescription = "<p><i>" + pageToRender["description"] + "</i></p>";
    }
    var recipeSteps = "<ul>" + pageToRender["steps"].map(s => "<li>" + s + "</li>").join("") + "</ul>";

    $(".instructions").html(recipeName + recipeDescription + recipeSteps);
}

function refreshIngredientsDisplay() {
    var buildString = "";
    for (var ingredient of ingredients) {
        buildString += "<p>" + ingredient + "</p>";
    }
    $("#recipe-ingredients").html(buildString);
}

$("#prev-button").click(function() {
    if (menuPosition > 0) {
        --menuPosition;
        refreshMenuDisplay();
    }
});

$("#next-button").click(function() {
    if (menuPosition < menu.length - 1) {
        ++menuPosition;
        refreshMenuDisplay();
    }
});

function addIngredient() {
  $.post(REQUEST_URL_ADD, JSON.stringify(
      {"ingredient": $("#new-ingredient").val().trim().toLowerCase()}),
      function(data) {
        var jsonData = $.parseJSON(data);
        $("#recipe-feedback").html(jsonData.feedback);
        if ('added' in jsonData) {
          ingredients.push(jsonData["added"]);
          refreshIngredientsDisplay();
        }
      });
  $("#new-ingredient").val("");
  $("#new-ingredient").focus();
  return false;
}

$("#recipe-controls").submit(addIngredient);

function validateIngredient() {
  $.post(REQUEST_URL_EXAMINE, JSON.stringify(
      {"ingredient": $("#new-ingredient").val().trim().toLowerCase()}),
      function(data) {
        var jsonData = $.parseJSON(data);
        $("#recipe-feedback").html(jsonData);
      });
  return false;
}

$("#ingredient-examine").click(validateIngredient);

function cook() {
  $.post(REQUEST_URL_COOK, JSON.stringify(
      {"ingredients": ingredients}),
      function(data) {
        var jsonData = $.parseJSON(data);
        guessLog.push([ingredients, (jsonData.recipe == "" ? "nothing good" : jsonData.recipe)]);
        if (jsonData.extra != null) {
          guessLog.push([jsonData.extra]);
        }
        $("#recipe-feedback").html(jsonData.feedback);
        ingredients = [];
        refreshIngredientsDisplay();
      });
}

function generateLogInfo() {
  var guessLogString = "<ul>";
  for (var guess of guessLog) {
    if (guess.length == 1) {
      guessLogString += "<li><b>" + guess[0] + "</b></li>";
    } else {
      guessLogString += "<li>" + guess[0].join(", ") + " -> " + guess[1] + "</li>";
    }
  }
  guessLogString += "</ul>";
  $("#modal-guess-log").html(guessLogString);
}
$("#recipe-cook").click(cook);

$(".modal-container").hide();

refreshMenuDisplay();

});
